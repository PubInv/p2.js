<!DOCTYPE html>
<html>
<head>
    <title>Piston demo - p2.js physics engine</title>
    <script src="../build/p2.js"></script>
    <script src="../build/p2.renderer.js"></script>
    <link href="css/demo.css" rel="stylesheet"/>
    <meta name="description" content="Shows how to build a small piston mechanism.">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
    <script>

var R = 0.7,
L = R * 3 / 2;

 var buttons = {
        space : false,
        left :  false,
        right : false,
 }
var arm2Body;
var armBody;
var secondArmBody;
var dummyBody;
var world;

    function init_double_pendulum() 
    {
    // Create arm
    var armShape =  new p2.Box({ width: L, height: 0.1*L });
	armBody = new p2.Body({
        mass:1,
	position: [L*(5/2),0]
    });
    armBody.addShape(armShape);
    world.addBody(armBody);


    // Constrain it to the world
    var c = new p2.RevoluteConstraint(armBody, dummyBody, {
        worldPivot: [L*2, 0],
        collideConnected: false
    });

    world.addConstraint(c);

    // SecondArm
    var secondArmShape = new p2.Box({ width: L, height: 0.1*L });
    secondArmBody = new p2.Body({
        mass: 1,
	position: [L*3,-L/2],
	angle: Math.PI/2
    });
    secondArmBody.addShape(secondArmShape);
    world.addBody(secondArmBody);

    // Connect secondArm to arm
    var c3 = new p2.RevoluteConstraint(secondArmBody, armBody, {
        localPivotA: [L/2,0],
        localPivotB: [L/2,0],
        collideConnected: false
    });
	world.addConstraint(c3);

	reset_double_pendulum();
    }

     function init_single_pendulum()
    {
        // Create arm
        var arm2Shape =  new p2.Box({ width: L*2, height: 0.1*L });
        arm2Body = new p2.Body({
            mass:1,
	    position: [-(L*3),0]
        });
        arm2Body.addShape(arm2Shape);
        world.addBody(arm2Body);


        // Constrain it to the world
        var c = new p2.RevoluteConstraint(arm2Body, dummyBody, {
            worldPivot: [-L*2, 0],
            collideConnected: false
        });
	world.addConstraint(c);
    }

function reset_double_pendulum()
{
    armBody.position= [L*(5/2),0];
    armBody.angle = 0;
    secondArmBody.position = [L*3,-L/2];
    secondArmBody.angle = 0;
}

function reset_single_pendulum()
{
    arm2Body.position =  [-(L*3),0];
    arm2Body.angle = 0;
}

// Create demo application
var app = new p2.WebGLRenderer(function(){

    world = new p2.World({
        gravity : [0,-1]
    });

    this.setWorld(world);

    world.solver.iterations = 30;
    world.solver.tolerance = 0.01;

    // Create static dummy body that we can constrain other bodies to
    dummyBody = new p2.Body({
        mass: 0,
    });
    world.addBody(dummyBody);


    init_double_pendulum();
    init_single_pendulum();
    var line = new p2.Line(L*4);
    var lbody = new p2.Body({
        position : [0,0],
    });
    lbody.addShape(line);
    world.addBody(lbody);
    
    
    // Create ground
    var planeShape = new p2.Plane();
    var plane = new p2.Body({
        position : [0,-5],
    });
    plane.addShape(planeShape);
    world.addBody(plane);

});

 window.onkeydown = function(event){
        switch(event.keyCode){
          case 38: // up
          case 32: // space
            if(!buttons.space){
		reset_single_pendulum();
		reset_double_pendulum();
              buttons.space = true;
            }
            break;
          case 39: // right
            buttons.right = true;
            break;
          case 37: // left
            buttons.left = true;
            break;
        }
      }

      window.onkeyup = function(event){
        switch(event.keyCode){
          case 38: // up
          case 32: // space
            buttons.space = false;
            break;
          case 39: // right
            buttons.right = false;
            break;
          case 37: // left
            buttons.left = false;
            break;
        }
      }

    </script>
</body>
</html>
